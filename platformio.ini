; ================================================================
; platformio.ini - ESP32-S3 진공 제어 시스템 v3.9.4 Hardened
; ================================================================

[platformio]
default_envs = esp32-s3-hardened

[common]
platform  = espressif32
board     = esp32-s3-devkitc-1
framework = arduino
lib_deps  =
    lovyan03/LovyanGFX @ ^1.1.9
    knolleary/PubSubClient @ ^2.8
    bblanchon/ArduinoJson @ ^6.21.3
    mathworks/ThingSpeak @ ^2.0.0
    milesburton/DallasTemperature @ ^3.11.0
    paulstoffregen/OneWire @ ^2.3.7

; ── 공통 빌드 플래그 ──
build_flags_common =
    -DCORE_DEBUG_LEVEL=0
    -DBOARD_HAS_PSRAM
    -DARDUINO_USB_CDC_ON_BOOT=1
    -DARDUINO_USB_MODE=1
    -DENABLE_THINGSPEAK=1
    -DENABLE_PREDICTIVE_MAINTENANCE=1
    ; ── v3.9.4 Hardened 플래그 ──
    -DHW_HARDENED=1
    -DPSRAM_SAFE_MODE=1
    ; Task WDT: idle 태스크 WDT 제외 (false positive 방지)
    -DCONFIG_ESP_TASK_WDT_TIMEOUT_S=15
    ; Brownout: ESP-IDF 레벨에서 설정
    -DCONFIG_ESP_BROWNOUT_DET_LVL=0

upload_speed  = 921600
monitor_speed = 115200
monitor_filters =
    esp32_exception_decoder
    time

; ================================================================
; [Release] Hardened 릴리즈 빌드
; ================================================================
[env:esp32-s3-hardened]
platform      = ${common.platform}
board         = ${common.board}
framework     = ${common.framework}
lib_deps      = ${common.lib_deps}
upload_speed  = ${common.upload_speed}
monitor_speed = ${common.monitor_speed}
monitor_filters = ${common.monitor_filters}
build_flags   =
    ${common.build_flags_common}
    -O2
    -DRELEASE_BUILD
    -DHW_HARDENED_RELEASE=1
board_build.partitions            = partitions_16mb.csv
board_build.filesystem            = spiffs
board_build.arduino.memory_type   = qio_qspi
; PSRAM: 반드시 OPI PSRAM 설정 (ESP32-S3)
board_build.arduino.partitions    = partitions_16mb.csv

; ================================================================
; [Debug] Hardened 디버그 빌드
; ================================================================
[env:esp32-s3-hardened-debug]
platform      = ${common.platform}
board         = ${common.board}
framework     = ${common.framework}
lib_deps      = ${common.lib_deps}
upload_speed  = ${common.upload_speed}
monitor_speed = ${common.monitor_speed}
monitor_filters = ${common.monitor_filters}
build_flags   =
    ${common.build_flags_common}
    -DCORE_DEBUG_LEVEL=5
    -DDEBUG_MODE=1
    -DHW_HARDENED_DEBUG=1
    ; SPI 충돌 상세 로그
    -DSPI_BUS_DEBUG=1
    ; I2C 복구 상세 로그
    -DI2C_RECOVERY_DEBUG=1
    ; DS18B20 상태 로그
    -DDS18B20_DEBUG=1
    ; Heap 모니터 상세 로그
    -DHEAP_MONITOR_VERBOSE=1
    -Og
    -g
board_build.partitions            = partitions_16mb.csv
board_build.filesystem            = spiffs
board_build.arduino.memory_type   = qio_qspi
